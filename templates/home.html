<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet">
  <style>
    .role-badge {
      font-size: 0.85rem;
      padding: 0.35em 0.6em;
      border-radius: 0.5rem;
    }
    .badge-admin { background-color: #dc3545; color: #fff; }
    .badge-customer { background-color: #0d6efd; color: #fff; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="#">User Management</a>
      <div class="d-flex align-items-center">
        <span class="text-white me-3">
          Logged in as <strong>{{ current_user.name }}</strong>
          <span class="role-badge {% if current_user.role == 'Admin' %}badge-admin{% else %}badge-customer{% endif %}">
            {{ current_user.role }}
          </span>
        </span>
        <a href="/logout" class="btn btn-outline-light btn-sm">Logout</a>
      </div>
    </div>
  </nav>

  <!-- Container -->
  <div class="container mt-4">
    {% include "_messages.html" %}

    {% if current_user.role == 'Admin' %}
    <!-- Add User Form -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        Add New User
      </div>
      <div class="card-body">
        <form id="userForm">
          <div class="row g-3">
            <div class="col-md-4">
              <input type="text" class="form-control" id="name" placeholder="Name" required>
            </div>
            <div class="col-md-4">
              <input type="email" class="form-control" id="email" placeholder="Email" required>
            </div>
            <div class="col-md-4">
              <input type="password" class="form-control" id="password" placeholder="Password" value="test123" required>
            </div>
            <div class="col-md-4">
              <select class="form-select" id="role" required>
                <option value="">-- Select Role --</option>
                <option value="Admin">Admin</option>
                <option value="Customer">Customer</option>
              </select>
            </div>
            <div class="col-md-12">
              <button type="submit" class="btn btn-success">Add User</button>
            </div>
          </div>
        </form>
      </div>
    </div>
    {% endif %}

    <!-- User Table -->
    <div class="card">
      <div class="card-header bg-secondary text-white">
        All Users
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped align-middle">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                {% if current_user.role == 'Admin' %}<th>Email</th>{% endif %}
                <th>Role</th>
                {% if current_user.role == 'Admin' %}<th>Actions</th>{% endif %}
              </tr>
            </thead>
            <tbody id="userTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">Confirm Delete</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this user?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-outline-danger" id="confirmDelete">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    let userIdToDelete = null;

    function loadUsers() {
      $.get('/users', function(users) {
        let rows = "";
        users.forEach(function(user) {
          rows += `
            <tr>
              <td>${user.id}</td>
              <td>${user.name}</td>
              ${user.email ? `<td>${user.email}</td>` : ""}
              <td>
                <span class="role-badge ${user.role === 'Admin' ? 'badge-admin' : 'badge-customer'}">${user.role}</span>
              </td>
              ${user.email ? `
                <td>
                  <button class="btn btn-outline-danger btn-sm" onclick="confirmDelete(${user.id})">
                    Delete
                  </button>
                </td>` : ""}
            </tr>
          `;
        });
        $("#userTable").html(rows);
      });
    }

    function confirmDelete(id) {
      userIdToDelete = id;
      const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
      modal.show();
    }

    $("#confirmDelete").click(function() {
      $.ajax({
        url: `/user/${userIdToDelete}`,
        type: 'DELETE',
        success: function() {
          loadUsers();
          bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
        }
      });
    });

    $("#userForm").submit(function(event) {
      event.preventDefault();
      const formData = {
        name: $('#name').val(),
        email: $('#email').val(),
        password: $('#password').val(),
        role: $('#role').val()
      };
      $.ajax({
        type: 'POST',
        url: '/user',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function() {
          loadUsers();
          $('#userForm')[0].reset();
        }
      });
    });

    $(document).ready(loadUsers);
  </script>
</body>
</html>


